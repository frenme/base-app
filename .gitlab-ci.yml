stages:
  - deploy

default:
  image: alpine:latest
  before_script:
    - apk add --no-cache git openssh-client docker-compose
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$DEPLOY_SERVER" >> ~/.ssh/known_hosts

.default_deploy:
  stage: deploy
  script:
    - |
      ssh "$DEPLOY_USER@$DEPLOY_SERVER" <<EOF
      cd ${PROJECT_PATH}/${SERVICE_PATH}
      git pull origin main
      docker compose down
      docker compose up -d
      EOF
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - ${SERVICE_PATH}/**/*

deploy_app:
  stage: deploy
  script:
    - |
      ssh "$DEPLOY_USER@$DEPLOY_SERVER" <<EOF
      cd ${PROJECT_PATH}/app
      git pull origin main
      docker compose down
      docker compose up -d --scale user-service=2 --scale order-service=1
      EOF
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - app/**/*

deploy_kafka:
  extends: .default_deploy
  variables:
    SERVICE_PATH: kafka

deploy_redis:
  extends: .default_deploy
  variables:
    SERVICE_PATH: redis

deploy_postgres:
  extends: .default_deploy
  variables:
    SERVICE_PATH: postgres

deploy_mongo:
  extends: .default_deploy
  variables:
    SERVICE_PATH: mongo

deploy_kong:
  extends: .default_deploy
  variables:
    SERVICE_PATH: kong